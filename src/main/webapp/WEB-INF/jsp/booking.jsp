<%@ page language="java" contentType="text/html;charset=UTF-8"
         pageEncoding="UTF-8"%>

<%-- page: booking.jsp --%>

<%@ taglib prefix="c"   uri="jakarta.tags.core" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>
<%@ taglib prefix="fn"  uri="jakarta.tags.functions" %>


<%
    // Titre de l'onglet
    request.setAttribute("pageTitle", "Réserver un trajet - Covoiturage");
   
%>

<%@ include file="layout.jspf" %>

<div class="row">
    <div class="col-md-8 offset-md-2">

        <%-- Message d'erreur --%>
        <c:if test="${not empty error}">
            <div class="alert alert-danger" role="alert">
                ${error}
            </div>
        </c:if>

        <%-- Si le trajet est introuvable --%>
        <c:if test="${empty ride}">
            <div class="alert alert-warning">
                Trajet introuvable.
            </div>
        </c:if>

        <%-- Si on a bien un trajet --%>
        <c:if test="${not empty ride}">

            <%-- Carte récapitulatif du trajet --%>
            <div class="card shadow-sm mb-4">
                <div class="card-body">

                    <h2 class="h4 mb-3">
                        ${ride.departureCityDisplay}
                        <span class="text-muted">&rarr;</span>
                        ${ride.arrivalCityDisplay}
                    </h2>

                    <p class="mb-1">
                        <strong>Date / heure: </strong>
                        ${ride.departureDateTimeFormatted}
                    </p>
					<%-- Prix du trajet complet --%>
                    <p class="mb-1">
                        <strong>Prix par place (trajet complet): </strong>
                        ${ride.pricePerSeat} €
                    </p>

                    <p class="mb-1">
                        <strong>Places totales: </strong>
                        ${ride.totalSeats}
                    </p>

                    <%-- ITINÉRAIRE DÉTAILLÉ --%>
                    <c:if test="${not empty ride.fullPath}">
                        <div class="mt-3">
                            <div class="small text-muted mb-1">
                                Itinéraire détaillé (${ride.stopsCountLabel})
                            </div>

                            <%-- On calcule UNE FOIS le prix "effectif" pour ce parcours --%>
                            <c:set var="effectiveUnitPrice" value="${ride.pricePerSeat}" />
                            <c:if test="${segmentUnitPrice != null}">
                                <c:set var="effectiveUnitPrice" value="${segmentUnitPrice}" />
                            </c:if>
                            
                            <%-- Sous-trajet choisi par le passager (si on vient d'une recherche) --%>
                            <c:if test="${not empty segmentFromCity and not empty segmentToCity}">
                                <p class="mt-3 mb-1">
                                    <strong>Votre parcours :</strong>
                                    ${segmentFromCity}
                                    <span class="text-muted">&rarr;</span>
                                    ${segmentToCity}
                                </p>

                                <%-- Prix du parcours réservé --%>
                                <p class="text-muted small mb-1">
                                    Prix par place pour ce parcours :
                                    <strong>${effectiveUnitPrice} €</strong>.
                                    Le montant total dépendra du nombre de places réservées.
                                </p>

                                <c:if test="${segmentStopsCount != null && segmentStopsCount > 0}">
                                    <p class="text-muted small mb-2">
                                        Inclut ${segmentStopsCount} arrêt(s) intermédiaire(s)
                                    </p>
                                </c:if>
                            </c:if>

                            <div class="itinerary-timeline">
                                <c:forEach var="city" items="${ride.fullPath}" varStatus="st">
                                    <div class="itinerary-stop
                                                ${st.first ? 'itinerary-stop-first' : ''}
                                                ${st.last ? 'itinerary-stop-last' : ''}">
                                        <div class="itinerary-stop-dot"></div>
                                        <div class="itinerary-stop-line"></div>
                                        <div class="itinerary-stop-label">
                                            <c:choose>
                                                <c:when test="${st.first}">
                                                    <strong>${city}</strong>
                                                    <span class="text-muted small ms-1">départ</span>
                                                </c:when>
                                                <c:when test="${st.last}">
                                                    <strong>${city}</strong>
                                                    <span class="text-muted small ms-1">arrivée</span>
                                                </c:when>
                                                <c:otherwise>
                                                    ${city}
                                                    <span class="text-muted small ms-1">arrêt</span>
                                                </c:otherwise>
                                            </c:choose>
                                        </div>
                                    </div>
                                </c:forEach>
                            </div>
                        </div>
                    </c:if>

                    <%-- Places restantes:
                         - si sous-trajet => segmentRemainingSeats
                         - sinon => remainingSeats
                    --%>
                    <c:set var="effectiveRemainingSeats"
                           value="${isSubRide and segmentRemainingSeats != null ? segmentRemainingSeats : remainingSeats}" />

                    <p class="mb-1">
                        <strong>Places restantes :</strong>
                        <c:choose>
                            <c:when test="${effectiveRemainingSeats <= 0}">
                                <span class="badge bg-danger ms-1">
                                    Trajet complet
                                </span>
                            </c:when>
                            <c:otherwise>
                                ${effectiveRemainingSeats}
                            </c:otherwise>
                        </c:choose>
                    </p>

                    <c:if test="${not empty ride.description}">
                        <p class="mt-2 mb-0">
                            <strong>Commentaire :</strong>
                            ${ride.description}
                        </p>
                    </c:if>

                </div>
            </div>

            <%-- Carte réservation --%>
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h3 class="h5 mb-3">Réserver ce trajet</h3>

                    <c:choose>

                        <%-- CAS 1: plus aucune place disponible --%>
                        <c:when test="${effectiveRemainingSeats <= 0}">
                            <div class="alert alert-warning mb-3">
                                Ce trajet est complet, il n'y a plus de place disponible.
                            </div>

                            <a href="${pageContext.request.contextPath}/rides"
                               class="btn btn-outline-secondary">
                                Retour à la liste
                            </a>
                        </c:when>

                        <%-- CAS 2: il reste des places --%>
                        <c:otherwise>
                            <form method="post"
                                  action="${pageContext.request.contextPath}/book">

                                <%-- Id du trajet --%>
                                <input type="hidden" name="rideId" value="${rideId}" />

                                <%-- Indices de sous-trajet (0 .. n-1) --%>
                                <input type="hidden" name="fromIndex"
                                       value="${segmentFromIndex != null ? segmentFromIndex : 0}" />

                                <input type="hidden" name="toIndex"
                                       value="${segmentToIndex != null ? segmentToIndex : fn:length(fullPath) - 1}" />

                                <%-- Prix par place pour ce parcours (sous-trajet ou trajet complet) --%>
                                <input type="hidden" name="unitPrice"
                                       value="${segmentUnitPrice != null ? segmentUnitPrice : ride.pricePerSeat}" />

                                <div class="mb-3">
                                    <label class="form-label">
                                        Nombre de places à réserver
                                    </label>
                                    <input class="form-control"
                                           type="number"
                                           name="seats"
                                           min="1"
                                           max="${effectiveRemainingSeats}"
                                           value="1"
                                           required>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    Confirmer la réservation
                                </button>

                                <a href="${pageContext.request.contextPath}/rides"
                                   class="btn btn-outline-secondary ms-2">
                                    Retour à la liste
                                </a>
                            </form>
                        </c:otherwise>

                    </c:choose>
                </div>
            </div>

        </c:if>

    </div>
</div>

<%@ include file="footer.jspf" %>



















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































